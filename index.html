<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>e-Civilian Portal â€“ Register</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

    // ðŸ”¹ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCs-pheSxe9bkAqnhG9qOjF7RvFfb9k00A",
      authDomain: "e-civilian-portal2007.firebaseapp.com",
      projectId: "e-civilian-portal2007",
      storageBucket: "e-civilian-portal2007.firebasestorage.app",
      messagingSenderId: "465001179759",
      appId: "1:465001179759:web:60a45e286fbf1a39ac7b9a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("registerForm");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const username = form.username.value.trim();
        const email = form.email.value.trim();
        const password = form.password.value.trim();
        const civilId = form.civilId.value.trim();

        if (!username || !email || !password || !civilId) {
          alert("Please fill in all fields.");
          return;
        }

        try {
          // ðŸ”¹ 1. Check if Civil ID exists
          const civilRef = doc(db, "civil_ids", civilId);
          const civilSnap = await getDoc(civilRef);

          if (!civilSnap.exists()) {
            alert("Invalid Civil ID.");
            return;
          }

          const civilData = civilSnap.data();
          if (civilData.used) {
            alert("This Civil ID is already registered.");
            return;
          }

          // ðŸ”¹ 2. Check if username already exists
          const usersRef = collection(db, "users");
          const usernameQuery = query(usersRef, where("username", "==", username));
          const usernameSnap = await getDocs(usernameQuery);

          if (!usernameSnap.empty) {
            alert("That username is already taken. Choose another one.");
            return;
          }

          // ðŸ”¹ 3. Create account in Firebase Auth
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const userId = userCredential.user.uid;

          // ðŸ”¹ 4. Save user info in Firestore
          await addDoc(usersRef, {
            uid: userId,
            username: username,
            email: email,
            civilId: civilId,
            registeredAt: serverTimestamp()
          });

          // ðŸ”¹ 5. Mark Civil ID as used
          await updateDoc(civilRef, { used: true });

          // ðŸ”¹ 6. Save in session + redirect
          sessionStorage.setItem("username", username);
          sessionStorage.setItem("email", email);
          sessionStorage.setItem("civilId", civilId);

          alert("Registration successful! Redirecting to dashboard...");
          window.location.href = "dashboard.html";
        } catch (error) {
          console.error("Error:", error);
          alert("Error: " + error.message);
        }
      });
    });
  </script>
</head>

<body>
  <h2>e-Civilian Portal â€“ Create Your Account</h2>
  <form id="registerForm">
    <label>Username:</label><br>
    <input type="text" name="username" required><br><br>

    <label>Email:</label><br>
    <input type="email" name="email" required><br><br>

    <label>Password:</label><br>
    <input type="password" name="password" required><br><br>

    <label>Civil ID:</label><br>
    <input type="text" name="civilId" required><br><br>

    <button type="submit">Register</button>
  </form>
</body>
</html>
