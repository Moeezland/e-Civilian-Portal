<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Moeezland e-Civilian Portal</title>
</head>
<body>
  <h2>Moeezland e-Civilian Portal</h2>

  <div id="register-section">
    <h3>Register for e-Civilian Account</h3>
    <input type="text" id="username" placeholder="Username" required><br><br>
    <input type="email" id="email" placeholder="Email" required><br><br>
    <input type="password" id="password" placeholder="Password" required><br><br>
    <input type="text" id="civilID" placeholder="Civil ID" required><br><br>
    <button id="registerBtn">Register</button>
    <p>Already have an account? <a href="#" id="goToLogin">Login here</a></p>
  </div>

  <div id="login-section" style="display:none;">
    <h3>Login</h3>
    <input type="email" id="loginEmail" placeholder="Email" required><br><br>
    <input type="password" id="loginPassword" placeholder="Password" required><br><br>
    <button id="loginBtn">Login</button>
    <p>No account? <a href="#" id="goToRegister">Register here</a></p>
  </div>

  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCs-pheSxe9bkAqnhG9qOjF7RvFfb9k00A",
      authDomain: "e-civilian-portal2007.firebaseapp.com",
      projectId: "e-civilian-portal2007",
      storageBucket: "e-civilian-portal2007.firebasestorage.app",
      messagingSenderId: "465001179759",
      appId: "1:465001179759:web:60a45e286fbf1a39ac7b9a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Switch between login/register
    document.getElementById('goToLogin').onclick = () => {
      document.getElementById('register-section').style.display = 'none';
      document.getElementById('login-section').style.display = 'block';
    };
    document.getElementById('goToRegister').onclick = () => {
      document.getElementById('register-section').style.display = 'block';
      document.getElementById('login-section').style.display = 'none';
    };

    // ✅ Registration
    document.getElementById('registerBtn').onclick = async () => {
      const username = document.getElementById('username').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      const civilID = document.getElementById('civilID').value.trim();

      if (!username || !email || !password || !civilID) {
        alert("Please fill all fields.");
        return;
      }

      try {
        const civilDoc = await getDoc(doc(db, "civil_ids", civilID));
        if (!civilDoc.exists()) {
          alert("Invalid Civil ID — not found in Moeezland database!");
          return;
        }
        if (civilDoc.data().used === true) {
          alert("This Civil ID is already used!");
          return;
        }

        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Wait for authentication confirmation
        onAuthStateChanged(auth, async (currentUser) => {
          if (currentUser) {
            // Save user info to Firestore
            await setDoc(doc(db, "users", currentUser.uid), {
              username: username,
              email: email,
              civilID: civilID,
              registered: new Date().toISOString()
            });

            // Mark the Civil ID as used
            await updateDoc(doc(db, "civil_ids", civilID), { used: true });

            alert("Account registered successfully! Redirecting...");
            window.location.href = "dashboard.html";
          }
        });

      } catch (error) {
        alert("Registration error: " + error.message);
      }
    };

    // ✅ Login
    document.getElementById('loginBtn').onclick = async () => {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value.trim();

      if (!email || !password) {
        alert("Enter your email and password!");
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, password);
        alert("Login successful! Redirecting...");
        window.location.href = "dashboard.html";
      } catch (error) {
        alert("Login error: " + error.message);
      }
    };
  </script>
</body>
</html>
